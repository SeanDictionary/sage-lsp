name: Publish to PyPI and GitHub Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+*'

jobs:
  build-n-publish:
    name: Build and publish
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write      # PyPI 发布权限
      contents: write    # 创建 GitHub Release 的写权限

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0    # 获取所有历史，方便生成日志

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.x"

    - name: Install build dependencies
      run: python -m pip install build

    - name: Build binary wheel and source tarball
      run: python -m build

    # 步骤 1: 发布到 PyPI
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1

    # 步骤 2: 自动创建 GitHub Release
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        # 自动生成发行说明（根据两次 tag 之间的 commit 记录）
        generate_release_notes: true
        # 将构建好的包也作为附件上传到 GitHub Release
        files: |
          dist/*.whl
          dist/*.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}